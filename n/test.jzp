/*
** test.jzp
*/

;
;; load supprot library
;
(src-load code.jzp)
(src-load list.jzp)

(subr entry-subr ()
  (push test-fibonacci)
  (call)
  (return)
)

(subr test-make-array ()
  (local array)
  (push (sizeof list))
  (push make-array)
  (call)
  (store array)
  (push nil)
  (load array)
  (set (indexof list.header))
  (load array)
  (ref (indexof list.header))
  (push system-ostream)
  (push stream-output)
  (call)
  (return)
)

(subr test-g-var ()
  (push 1.0)
  (pop flag)
  (push flag)
  (push system-ostream)
  (push stream-output)
  (call)
  (return)
)

(subr test-factorial ()
  (push 10)
  (push factorial)
  (call)
  (push system-ostream)
  (push stream-output)
  (call)
  (return)
)

(subr test-fibonacci ()
  (push 23)
  (push fibonacci)
  (call)
  (push system-ostream)
  (push stream-output)
  (call)
  (return)
)

(subr test-count (x)
  (local tmp)
  (load x)
  (store tmp)
  (label l1)
  (push 1)
  (load tmp)
  (sub)
  (store tmp)
  (load tmp)
  (push 0)
  (eq)
  (not)
  (jmpi l1)
  (return)
)

(subr test-output ()
  (push "hello world!")
  (push system-ostream)
  (push stream-output)
  (call)
  (return)
)

(subr test-string ()
  (local char)
  (local tmp)
  (push 0)
  (store tmp)
  (label continue)
  (push "hello world!")
  (ref tmp)
  (store char)
  (load char)
  (push system-ostream)
  (push stream-output)
  (call)
  (load char)
  (push '!')
  (eq)
  (jmpi exit)
  (load tmp)
  (push 1)
  (add)
  (store tmp)
  (jmp continue)
  (label exit)
  (return)
)

(subr test-find-maximum ()
  (local array)
  (local index)
  (push 10)
  (push make-array)
  (call)
  (store array)
  (push 0)
  (store index)
  (label init-array) ; init array
  (load index)
  (push 10)
  (eq)
  (jmpi start)
  (load index)
  (load array)
  (set index)
  (load index)
  (push 1)
  (add)
  (store index)
  (jmp init-array)
  (label start) ; start call find the maximum
  (load array)
  (push 10)
  (push find-maximum)
  (call)
  (push system-ostream)
  (push stream-output)
  (call)
  (retvoid)
)

(test-find-maximum)

;(test-fibonacci)

;(test-string)